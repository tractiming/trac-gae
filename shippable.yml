language: python

python:
  - 2.7

env:
  global:
    - SETTINGS_MODE=test
    - GAE_DIR=/tmp/gae
    - secure: scUW0gNpvMyfRLoLyHAZu1j4QkAfCugaxdB3b+qMjePlcyU0jyAZaGP8krl31Xb3UEeOIHG73q/rGiAROkB3cYRO3xTdjD2YBme6Hh9GEO8hxWCHBbkCQ4o4ao3FOnXoNmyUMaQim0HDksvqjyJCK8EP8qdPtievPlB/Y+UhP3jxNQYE4cViE6Ye9mFIfWfNTgujs2ukfLTJQ628XTcEJCzNmg9ihd84DH2SYBxpTLQ1TkRXNqkCDqcQAaGVG78zkFDz6m5u7VXp4lZg9iG/CcrwdfxKlnzRqUQ1PKQuoLOexDCMCPZ1RkL0nQMfY7Qt1eV+T8h3rj+s1EZgAVcbjFgmuXbEG8MVUlXxpJyOcBJ0IpaqCdI+UaLOQ6UruvoWM8BrZBFpRHPF5+0Mf+0GVxcTtA6zweTnm7wzDOY+GcpWug6JNwhz3F40kmxbcTPPoNoz7CTj+a6vvWZaDrceAv+3JB//WGsU5Uu+zJkZWpAKlkT+rdLIDgXZMaBU3O0FxLfElVSHB6GG4s15QjBInqjYw20h5tyKqzDCONk6BoMEV6kE2wvfwN//qTyYRruYeDGLYcIFq0luvCDEwlYFpNsGEU1p76CC4Mt5V1/sziizjI463jYvchoNvCeg+FOr0BaZLNhTl9YaKf+eKL6hm70aJIpHYrsE2g51Yx9F5ss=

install:
  - pip install -r requirements/production.txt
  - pip install -r requirements/test.txt

before_script:
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  - mysql -e 'create database test;'

script:
  - python manage.py test apps

after_success:
  - >
    if [ "$BRANCH" == "master" ] && [ "$PULL_REQUEST" = false ]; then
    (test -e $GAE_DIR || (mkdir -p $GAE_DIR &&
    wget 'https://storage.googleapis.com/appengine-sdks/featured/google_appengine_1.9.25.zip' -q -O /tmp/gae.zip &&
    unzip /tmp/gae.zip -d $GAE_DIR -x "google_appengine/lib/django*")) && ./deploy.sh;
    fi
