{% extends "base.html" %}
{% load staticfiles %}

{% block content %}
<script type="text/javascript" src="{% static "js/timeConversion.js" %}" />
   <script>
	$(document).ready(function(){
	if (sessionStorage.usertype == 'athlete'){
		$("form#coachform").hide();
		load();
		}
		//if a coach
	else {
		$("form#myform").hide();
		loadtags();}
	});
	</script>
	<script>
		var stepped = 0, rowCount = 0, errorCount = 0, firstError;
		var inputType = "string";
		$(document).ready(function(){
	    
	    $("#csvform").on('submit', function(e){
			e.preventDefault();
			var config = buildConfig();
			
$('#file').parse({
			config:config,
			before: function(file, inputElem)
				{
					start = now();
					console.log("Parsing file...", file);
				},
				error: function(err, file)
				{
					console.log("ERROR:", err, file);
					firstError = firstError || err;
					errorCount++;
				},
			
			complete: function(){
				end = now();
				printStats("Done with all files");
				

				
				
			}
		});
	});
});
	function now()
{
	return typeof window.performance !== 'undefined'
			? window.performance.now()
			: 0;
}

function buildConfig()
{
	return {
		delimiter: '',
		header: true,
		dynamicTyping: false, //turn numbers into numbers or strings? yes no to boolean?
		skipEmptyLines:true,
		preview: parseInt($('#preview').val() || 0),
		step: $('#stream').prop('checked') ? stepFn : undefined,
		encoding: '',
		worker: true, //run on separate thread--slower but wont lock webpage
		comments: $('#comments').val(),
		complete: completeFn,
		error: errorFn,
		download: inputType == "remote"
	};
}

function stepFn(results, parser)
{
	stepped++;
	if (results)
	{
		if (results.data)
			rowCount += results.data.length;
		if (results.errors)
		{
			errorCount += results.errors.length;
			firstError = firstError || results.errors[0];
		}
	}
}

function completeFn(results)
{
	end = now();

	if (results && results.errors)
	{
		if (results.errors)
		{
			errorCount = results.errors.length;
			firstError = results.errors[0];
		}
		if (results.data && results.data.length > 0)
			rowCount = results.data.length;
			
	}

	printStats("Parse complete");
	console.log("    Results:", JSON.stringify(results.data));
	var dated = $('input[id=date]').val();
	var reads = $('input[id=readers]').val();
	var workoutName = $('input[id=name]').val();
	var username =$('input[id=username]').val();

	//I made a manipulated string that allows users to input a list of readers and separates each reader.
	var readersList = reads.split(",");
	var rL = "";
	for(var j = 0; j < readersList.length; j++){
		rL = rL.concat('"'+readersList[j]+'"');
		if (j != readersList.length - 1){
			rL = rL.concat(',');
		}
	}
	rL = '['+rL+']';
	rL = rL.replace(/\s/g, '');
	dL = local2UTC(dated);
	console.log(dL);
	//The manipulated string matches the api conventions and successfully creates new races with the readers that user inputs.
	var json = '{"race_name":"'+workoutName+'","race_date":"'+dL+'","director_username":"'+username+'","readers":'+rL+',"athletes":'+JSON.stringify(results.data)+'}';
	console.log(json);
	$.ajax({
           type: "POST",
           dataType:'json',
           url: "/api/raceregistration/",
	   headers: {Authorization: "Bearer " + sessionStorage.access_token},
           data:json,
           // Login was successful.
           success: function(data) {alert('yes')},
           error: function(xhr, errmsg, err) {alert('error')}
	   });
			
			$('#file').val('');
	// icky hack
	//setTimeout(enableButton, 100);
}

function errorFn(err, file)
{
	end = now();
	console.log("ERROR:", err, file);
	//enableButton();
}
function printStats(msg)
{
	if (msg)
		console.log(msg);
	console.log("       Time:", (end-start || "(Unknown; your browser does not support the Performance API)"), "ms");
	console.log("  Row count:", rowCount);
	if (stepped)
		console.log("    Stepped:", stepped);
	console.log("     Errors:", errorCount);
	if (errorCount)
		console.log("First error:", firstError);
}
</script>
	
<script>
//coaches jquery to call athletes and idnumbers
$(document).ready(function() {
		//load();

        $("#coachform").on('submit', function(e){
            e.preventDefault();
	    $(".modal-animate").show();
            var form = $(this);

            form.parsley().validate();

	    
	    
            if (form.parsley().isValid()){
	            // var title=$('input[id=title]').val();
	           var first=$('input[id=first]').val();
	            var last=$('input[id=last]').val();  
		      var id_number=$('input[id=number]').val();
		    

	      $.ajax({
           type: "POST",
           dataType:'json',
           invokedata:{data1:id_number,},
           url: "/api/athletes/",
	   headers: {Authorization: "Bearer " + sessionStorage.access_token},
           data: {
               first_name: first,
               last_name:last,
               username:first+""+last,
           },
           // Login was successful.
           success: function(data) {
			   var userid = data.id;
			   var id_number = this.invokedata.data1;
			   //alert(id_number);
			   $.ajax({
           type: "POST",
           dataType:'json',
           url: "/api/tags/",
	   headers: {Authorization: "Bearer " + sessionStorage.access_token},
           data: {
              id_str:id_number,
              user:userid,
               
           },
           // create athlete
           success: function(data) {

		    $(".modal-animate").hide();
		    $("h6.notification.notification-critical").hide();
		    $("h6.notification.notification-success").show();
		    $("#coachform")[0].reset();
		    loadtags();
			   },
			   error:function(xhr,errmsg,err){
				   //created the username but not the tag to user
				    $(".modal-animate").hide();
	    $("h6.notification.notification-success").hide();
               $("h6.notification.notification-critical").show();
				   }
			   
			   });
			   
			   
           },

           // create athlete failed.
           error: function(xhr, errmsg, err) {
	    $(".modal-animate").hide();
	    $("h6.notification.notification-success").hide();
               $("h6.notification.notification-critical").show();
           }
           
      });
               
            }
        });
    });


</script>
<script>
    
    function uploadCSV(){
     $("form#coachform").hide();
     $("form#csvform").show();
     $("button#csvbutton").hide();
     $("button#example").show();
     $("button#individualbutton").show();
        
    }
    
    function uploadIndi(){
     $("form#coachform").show();
     $("form#csvform").hide();
     $("button#csvbutton").show();
        $("button#example").hide();
     $("button#individualbutton").hide();
        
    }

</script>

	<script>
		//for athlete load their personal tags
    $(document).ready(function() {
		//loadtags();
        $("#myform").on('click', '#submit', function(e){
            e.preventDefault();
	    $(".modal-animate").show();



	    
	    
          
	            // var title=$('input[id=title]').val();
		      var id_number=$('input[id=id_number]').val();
		   
               JSONObject = {'id_str':id_number};
                            
           		    
	      $.ajax({
          type: "POST",
           dataType:'json',
           contentType:'application/json',
           url: "/api/tags/",

	   headers: {Authorization: "Bearer " + sessionStorage.access_token
		   },
           data: JSON.stringify(JSONObject),
           // Login was successful.
           success: function(data) {
		    $(".modal-animate").hide();
		    $("h6.notification.notification-critical").hide();
		    $("h6.notification.notification-success").show();
		    $("#myform")[0].reset();
		    load();
                   
           },

           // Login request failed.
           error: function(xhr, errmsg, err) {
			   $(".modal-animate").hide();
	    $("h6.notification.notification-success").hide();
               $("h6.notification.notification-critical").show();
           }
           
      });
               
            
        });
    });
    
    //add new button functionality for individual athlete
    
    

$("body").on('click', 'tr',function(){
	//alert($(this).html());
	var value = $(this).html();
	$("input#delete").show();
	$("input#update").show();
	$("div.button-container-two").show();
	$("input#create").show();
	$("p#idnumber").show();
	//$("input#submit").hide();
	$(value).each(function(index){
		//alert( $(this).html() );
		console.log( index+ ":"+ $(this).html());
		if (index ==0)
		{
			var input =$('input#idnumber');
			input.val($(this).html() );
		}
		else if (index ==1)
		{
			var input =$('input#id_number');
			input.val($(this).html() );
			}

	});
	
	

	
	
	});
	


	$("body").on('click', 'input#delete',deleteTags);
	
	

			
			function deleteTags(f){
	//alert($(this).html());
	
	  f.preventDefault();
	  $("h6.notification.notification-warning").show();
	  $("h6.notification.notification-critical").hide();
	  $("h6.notification.delete-success").hide();
	  		    $("h6.notification.notification-critical").hide();
		    $("h6.notification.notification-success").hide();
		
	  
	  $("body").on('click','button', function(event){
	console.log("On:", event.target);
	var value = $(this).html();
	
	
	if (value == 'Yes'){ $(".modal-animate").show();
	  
	 var id=$('input[id=idnumber]').val();
	//alert(id);
	//alert('test');
	//alert(value);
		//alert(filter);
	      $.ajax({
           type: "DELETE",
           dataType:'json',
           url: "/api/tags/"+id,
	   headers: {Authorization: "Bearer " + sessionStorage.access_token},
         
           // Login was successful.
           success: function(data) {
		    //hide spinner, success modal, and reset form
		    $(".modal-animate").hide();
		    $("h6.notification.notification-critical").hide();
		    $("h6.notification.notification-success").hide();
		
		    $("h6.notification.delete-success").show();
		     $("h6.notification.notification-warning").hide();
		    $("#myform")[0].reset();
		    	$("input#delete").hide();
	$("input#update").hide();
	$("input#submit").show();
	$("p#idnumber").hide();
	$("input#create").hide();
		    load();
		    $("button#warning-yes").unbind('click',deleteTags);
                   
           },

           // Login request failed.
           error: function(xhr, errmsg, err) {
	    //hide spinner, show error modal
	    $(".modal-animate").hide();
	    $("h6.notification.notification-success").hide();
	     $("h6.notification.notification-warning").hide();
	
		    $("h6.notification.delete-success").hide();
               $("h6.notification.notification-critical").show();
           }
           
      });
      }
	else if(value =='Cancel'){
		$(".modal-animate").hide();
	    $("h6.notification.notification-success").hide();
	    $("h6.notification.notification-warning").hide();
              
		}
	
	 });
	  
	  
	
	}
			


//functon to load tags
function loadtags(){
			 $('#tagresults').empty();
		  //alert(path);
		  //alert(path);
		   $.ajax({
                     url: "/api/tags/",
		     headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data) {
                        //alert(data);
                        //data downloaded so we call parseJSON function 
                        //and pass downloaded data
                        
                        var json = $.parseJSON(data);
                       //alert(json[0].id_str)
                       for (var ii=0;json.length;ii++){
						   //alert(ii);
						   firstname = json[ii].first_name;
						   lastname = json[ii].last_name;
						   userid= json[ii].user;
						   referenceid = json[ii].id;
						   rfidnum = json[ii].id_str;
						  if (ii==0) {
			    $('#tagresults').append('<tr><th>Reference ID</th><th>ID Number</th><th>User Number</th><th>First Name</th><th>Last Name</th></tr>');
			    $('#tagresults').append('<tr class="odd"><td>'+referenceid+'</td><td>'+rfidnum+'</td><td>'+userid+'</td><td>'+firstname+'</td><td>'+lastname+'</td></tr>');
			    //alert(name);
			  }
			  else if((ii)%2 ==0) {
			    $('#tagresults').append('<tr class="odd"><td>'+referenceid+'</td><td>'+rfidnum+'</td><td>'+userid+'</td><td>'+firstname+'</td><td>'+lastname+'</td></tr>');
			  }
			  else{
			    $('#tagresults').append('<tr><td>'+referenceid+'</td><td>'+rfidnum+'</td><td>'+userid+'</td><td>'+firstname+'</td><td>'+lastname+'</td></tr>');
			    //alert(name);
			  }
						   }

			}
			
			
			
                    });
		   
}

    
	    </script>
	
	


<div class="modal-animate hide">
    <div class="rotate"></div>

</div>

    <div id="create">  
     <h2>Settings</h2>
     
	  <div id="notifications">
        <h6 class="notification notification-critical" role="alert">Some information you entered isn't right.</h6>
	<h6 class="notification notification-success" role="alert">You have successfully registered an ID!</h6>
		<h6 class="notification delete-success" role="alert">You have successfully deleted an ID!</h6>
	<h6 class="notification notification-warning" role="alert">Are you sure? <div class="container" id="screen-selector"><button href="#" type="button" id="warning-yes">Yes</button><button id="warning-no" href="#" type="button" style="float:right">Cancel</button></div></h6>
    </div>
	  
    <div id="contentleft">
					

		
		
		<button id="csvbutton" onclick="javascript:uploadCSV();">+ Upload CSV</button>
        <button id="individualbutton" onclick="javascript:uploadIndi();">+ Individual</button>
        <form method="get" action="/static/files/test.csv">
        <button type="submit" id="example" >Example</button>
            </form>
        
		<form name="coachform" id="coachform" method="POST" data-parsley-validate>

		
		   <p>
		      <label for="">First Name:</label> 
		      <input data-progression="" type="text" data-helper="" id="first" value="" placeholder="" required data-parsley-group="block1" />
		  </p>
		   <p>
		      <label for="">Last Name:</label> 
		      <input data-progression="" type="text" data-helper="" id="last" value="" placeholder="" required data-parsley-group="block1" />
		  </p>
		   <p>
		      <label for="">ID Number:</label> 
		      <input data-progression="" type="text" data-helper="" id="number" value="" placeholder="" required data-parsley-group="block1" />
		  </p>
		
		     
		     
		          <div class="button-container">
		    <input type="submit" name="" class="validate" id="submit" value="Save" />
	                         </div>
		</form>
        
        <form name="csvform" id="csvform"  data-parsley-validate>
        
		
 <p>
		      <label for="">Workout Name:</label> 
		      <input data-progression="" type="text" data-helper="" id="name" value="" placeholder="" />
		  </p>
		   <p>
		      <label for="">Workout Date:</label> 
		      <input data-progression="" type="text" data-helper="" id="date" value="" placeholder="" />
		  </p>
                        <p>
		      <label for="">Confirm Username:</label> 
		      <input data-progression="" type="text" data-helper="" id="username" value="" placeholder=""  />
		  </p>
		   <p>
		      <label for="">Readers:</label> 
		      <input data-progression="" type="text" data-helper="" id="readers" value="" placeholder="" />
		  </p>
		
		     
		     
		          <div class="button-container">
		    <input type="file" id="file" name="myfile" value="Choose File">
				<input type="submit" class="gen_btn" id="upload" name ="upload" value="Upload">
	                         </div>
		</form>
         
					
					
				
    </div>
                   <div id="contentright">
			      <div class ="outer">
      <div class="inner">
       <table id="tagresults" style="width:100%"></table>
       </div>
       </div>
      
              </div>
    
    
     
      </div>
    {% endblock %} 
    
    
    
</html>


