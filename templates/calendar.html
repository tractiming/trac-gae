{% extends "base.html" %}
{% load staticfiles %}

{% block content %}

<script>



$(document).ready(function() {
  $(".modal-animate").show();
  
  //import 3rd party calendar, but first import events--async call and reformat dates to fit 3rd party calendar
      $.ajax({
                    url: "/api/sessions/",
                    //force to handle it as text
                    dataType: "text",
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    success: function(dateList) {
		       var json = $.parseJSON(dateList);
		     //parse data, initialize variable
			var formattedList = [];
			//loop through list of json
			for (ii=0; ii<json.length;ii++) {
			  //iterate through and pull out id, url, and start date.
			  var url = "/api/sessions/";
			  var str = json[ii].start_time;
			  str = str.slice(0,10);
			  //reformat into objects in formatted list
			  formattedList.push({title : json[ii].name, url : url+json[ii].id, start : str});
			 
			}
		      
		$('#contentleft').fullCalendar({
			editable: true,
			eventLimit: true, // allow "more" link when too many events
			events: formattedList //calls list from function above
		});
		   

		$(".modal-animate").hide();
		$("h6.notification.notification-default2").show();
               
            
        
		    }});
      
      });
		
	     
	

    </script>
    <script>


function demoFromHTML() {
    var pdf = new jsPDF('p', 'pt', 'letter')

// source can be HTML-formatted string, or a reference
// to an actual DOM element from which the text will be scraped.
, source = $('.inner')[0]

// we support special element handlers. Register them with jQuery-style
// ID selector for either ID or node name. ("#iAmID", "div", "span" etc.)
// There is no support for any other type of selectors
// (class, of compound) at this time.
, specialElementHandlers = {
    // element with id of "bypass" - jQuery style selector
    '#bypassme': function(element, renderer){
        // true = "handled elsewhere, bypass text extraction"
        return true
    }
}

margins = {
    top: 80,
    bottom: 60,
    left: 40,
    width: 522
  };
  // all coords and widths are in jsPDF instance's declared units
  // 'inches' in this case
pdf.fromHTML(
    source // HTML string or DOM elem ref.
    , margins.left // x coord
    , margins.top // y coord
    , {
        'width': margins.width // max width of content on PDF
        , 'elementHandlers': specialElementHandlers
    },
    function (dispose) {
      // dispose: object with X, Y of the last line add to the PDF
      //          this allow the insertion of new lines after html
        pdf.save('Test.pdf');
      },
    margins
  )
    
    
}


</script>
  <script>
     $(document).ready(function() {
      
      var path = null;
    		    //on click prevent default, going to url normally
		$(document).on('click','a.fc-day-grid-event',function(event) {
		 $(".modal-animate").show();
		  event.preventDefault();
		  
		  path = $(this).attr('href').split('#');
		  //alert(path);
		   $.ajax({
                    url: path,
		     headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data) {
                        
                        //data downloaded so we call parseJSON function 
                        //and pass downloaded data
                        var prejson = $.parseJSON(data);
			//json = $.parseJSON(json.results);
                        //now json variable contains data in json format
                        //let's display a few items
                      json = $.parseJSON(prejson.results);
			  
			    $("h6.notification.notification-default2").hide();
				
			//if runners is blank show date and name of workout, and display message and button to download blank workout, center everything	
			if (json.runners == "") {
			  $(".outer").hide();
			  $(".modal-animate").hide();
			  $('#results').empty();
			  $('.title').css('text-align','center');
			  $('.title').html('<p>Title: ' + prejson.name);
			
			$('.title').append('<p> Date: ' + json.date);
			
			  
			    $("h6.notification.notification-default").show();
			      $("input#submit.gen_btn").show();
                $("button.pdfbutton").show();
			      
			}
			// show name and date, dont show message, but show button
			else {
			  $(".modal-animate").hide();
			  $(".outer").show();
			  $("h6.notification.notification-default").hide();
			  $("input#submit.gen_btn").show();
              $("button.pdfbutton").show();
			  
			  $('.title').css('text-align','left');
			  $('.title').html('<p>Title: ' + prejson.name);
			
			$('.title').append('<p> Date: ' + json.date);
			  
			  
			  //then display the workout
			  var longest = 0;
			var importantRow;
			for (var ii = 0; ii < json.runners.length; ii++) {
			  for (var jj = 0; jj < json.runners[ii].interval.length; jj++){
			    if (jj == 0) {
			      //initilize temporary variable
			      var tempLength = json.runners[ii].interval[jj].length;
			    }
			    else{
			      tempLength = tempLength + json.runners[ii].interval[jj].length;
			    }  
			 }
			  if (longest < tempLength) {
			    longest = tempLength;
			    importantRow = ii;
			  } 
			
			}
			  
			  
			  
			  
			  $('#results').empty();
			for (var i=0; i < json.runners.length; i++) {
			  //print names and enter name array
			  var name = json.runners[i].name;
			  //prints all splits with no nesting
			  //var interval = json.runners[i].interval
			  if (i==0) {
			    $('#results').append('<tr><td>Name</td></tr>');
			    $('#results').append('<tr class="odd"><td>'+name+'</td></tr>');
			  }
			  else if((i)%2 ==0) {
			    $('#results').append('<tr class="odd"><td>'+name+'</td></tr>');
			  }
			  else{
			    $('#results').append('<tr><td>'+name+'</td></tr>');
			  }
			  
			  
			  var finaltime = 0;
			  
			  for (var j=0; j < json.runners[i].interval.length; j++) {
			    //iterate over interval to get to nested time arrays
			    var interval = json.runners[i].interval[j];
			    //$('#results').append( "Interval Subset: ")
			    

			    for (var k=0; k < json.runners[i].interval[j].length; k++) {
			      //interate over subarrays and pull out each individually and print
			      var subinterval = json.runners[i].interval[j][k];
			      var min = Math.floor(subinterval/60);
			      var sec = (subinterval-(min*60));
			     // $('#results').append('<td>');
			      //This if statements adds the preceding 0 to any second less than 10
			      $('#results tr:last').append('<td>'+ subinterval +'</td>');
			      //if (sec<10) {
				//$('#results tr:last').append('<td>'+ min + ':0'+ sec +'</td>');
			      //}
			      //else
			      //{
			      //$('#results tr:last').append('<td>'+ min + ':'+ sec +'</td>');
			      //}
			      finaltime = finaltime + subinterval;
			      if (i==importantRow) {
				//Puts the word 'split #' on table
				$('#results tr:first').append('<td>' + 'Split' + '</td>');
			      }
			    }
			    
			    
			  }
			  
			  //to implement total time-- not necessary for this moment
			  
			//   var minfinal = Math.floor(finaltime/60);
			//   var secfinal = (finaltime-(minfinal*60));
			//   
			//   if (secfinal<10) {
			//    $('#results tr:last').append( minfinal + ':0'+ secfinal );
			//   }
			//   else{
			//   $('#results tr:last').append( minfinal + ':'+ secfinal);
			//   };
			//   if (i==0) {
			//	//adds word final time to table header
			//	$('#results tr:first').append('<td>Final Time</td>');
			//      }
			
			}
			
			}
			
                    }
                });

		
		});
		
		//if chose to download the workout, show spinner, then ajax call
		
		$('#submit').click(function(){
		  $(".modal-animate").show();
		  
        $.ajax({
                    url: path,
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data) {
		      
        
        JSONToCSVConvertor(data, "TRAC_Report", true);
	$(".modal-animate").hide();
	}});
    });
		
		
		
		
		
		function JSONToCSVConvertor(JSONData, ReportTitle, ShowLabel) {
    //Data coming in must be json
    //parse through it
    var json = $.parseJSON(JSONData);
  //now json variable contains data in json format
  //let's display a few items
 // $('#results').html('Date: ' + json.date);
  //$('#results').append('<p> Workout ID: '+ json.workoutID);
  
  
  
    var CSV = '';    
    //Set Report title in first row or line
    
    CSV += ReportTitle + '\r\n\n';
    CSV += 'Date,'+ json.start_time+'\r\n';
    CSV += 'Workout ID,'+ json.id+'\r\n\n';
   //alert(CSV);
   CSV += 'Name \r\n'
   //Uncomment below when using nested json in production
   json = $.parseJSON(json.results);
   
	      //iterate into name array
	       for (var i=0; i < json.runners.length; i++) {
		  //print names and enter name array
		  var name = json.runners[i].name; 
		    CSV +=name+',';
		  
		//alert(CSV);
   
   
			for (var j=0; j < json.runners[i].interval.length; j++) {
			    //iterate over interval to get to nested time arrays
			    var interval = json.runners[i].interval[j];

			    for (var k=0; k < json.runners[i].interval[j].length; k++) {
			      //interate over subarrays and pull out each individually and print
			      //do a little math to move from seconds to minutes and seconds
			      var subinterval = json.runners[i].interval[j][k];
			     // var min = Math.floor(subinterval/60);
			      //var sec = (subinterval-(min*60));
			      CSV += subinterval+',';
			      //This if statements adds the preceding 0 to any second less than 10
			      //if (sec<10) {
				//CSV += min + ':0'+sec+',';
			      //}
			      //else
			      //{
			      //CSV += min + ':'+sec+',';
			      //}
			      
			    }
			  }
			  //moves to new row on excel spreadsheet
			  CSV += '\r\n'
	       }
   
   //if varaible is empty, alert invalid and return
    if (CSV == '') {        
        alert("Invalid data");
        return;
    }
    
    //Generate a file name
    var fileName = "MyReport_";
    //this will remove the blank-spaces from the title and replace it with an underscore
    fileName += ReportTitle.replace(/ /g,"_");   
    
    //Initialize file format you want csv or xls
    var uri = 'data:text/csv;charset=utf-8,' + escape(CSV);
    
    // Now the little tricky part.
    // you can use either>> window.open(uri);
    // but this will not work in some browsers
    // or you will not get the correct file extension    
    
    //this trick will generate a temp <a /> tag
    var link = document.createElement("a");    
    link.href = uri;
    
    //set the visibility hidden so it will not effect on your web-layout
    link.style = "visibility:hidden";
    link.download = fileName + ".csv";
    
    //this part will append the anchor tag and remove it after automatic click
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
		
		
		
		
		
		
		
		
		
		
		
     });
  </script>

<div class="modal-animate hide">
    <div class="rotate"></div>

</div>
    
    <div id="calendar">  
     <div id="contentleft">
      
      
      
     </div>
     
     <div id="contentright">
      <div class="title"></div>
       <div class ="outer">
      <div class="inner">
       <table id="results" style="width:100%"></table>
       </div>
       </div>
           <div id="notifications">
        <h6 class="notification notification-default" role="alert">There is currently no data for this event.</h6>
        <h6 class="notification notification-default2" role="alert">Please select a workout.</h6>
    </div>
       <div class="button-container">
  <input type="submit" name="" class="gen_btn" id="submit" value="Download" />
  <button class="pdfbutton"onclick="javascript:demoFromHTML();">PDF</button>
</div>


     </div>
      </div>
    
    
    
    
    
    
    
    
{% endblock %} 
    
    
    
</html>


