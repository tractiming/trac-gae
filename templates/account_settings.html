{% extends "base_new.html" %}
{% load static %}

{% block stylesheets %}
<link rel="stylesheet" href="{% static "css/new/main.css" %}" />
<link rel="stylesheet" href="{% static "css/new/score.css" %}" />
<link rel="stylesheet" href="{% static "css/new/create.css" %}" />
<style>
    #edit-password, #edit-information{
      width:300px;
      margin: 0 auto;
    }
    label{
      display:block;
    }
    input,textarea{
      width:75%;
    }
  </style>
{% endblock %}

{% block js_scripts %}

<script>
if (sessionStorage.access_token == null) {
    //link to login page
    location.href="/login";
}
else{
    
}
    $(document).ready(function() {
$("li a.logout").click(function(){
    sessionStorage.clear();
    location.href="/login";
});
    });
</script>
<script type="text/javascript" src="{% static "js/timeConversion.js" %}" />
{% endblock %}

{% block content %}

<script>
$(document).ready(function(){
      $('body').on('click', 'a#e_profile', function(e){
          e.preventDefault();
          $('#display-title').text('General');
          $('#edit-password').hide();
          $('#payment').hide()
          $('#athletes').hide();
          $('#edit-information').fadeIn(500);
          $.ajax({
                  type: "GET",
                  url: "/api/users/me/",
                  headers: {Authorization: 'Bearer ' + sessionStorage.access_token},
                  success: function(data){
                    $('#edit-information #organization').val('org');
                    $('#edit-information #username').val(data['username']);
                    $('#edit-information #email').val(data['email']);
                  },
                  error: function(xhr, errmsg, err){
                  }
          });
      });
      $('body').on('click', 'a#e_password', function(e){
          e.preventDefault();
          $('#display-title').text('Security');
          $('#edit-information').hide();   
          $('#payment').hide(); 
          $('#athletes').hide();      
          $('#edit-password').fadeIn(500);
      });
      $('body').on('click', 'a#e_payment', function(e){
          e.preventDefault();
          location.href='/payments/change/cards/';
      });
      $('body').on('click', 'a#e_roster', function(e){
          e.preventDefault();
          $('#display-title').text('Roster');
          $('#edit-information').hide();   
          $('#athletes').fadeIn(500);       
          $('#edit-password').hide();
          $.ajax({
              url: '/api/athletes/',
              headers: {Authorization: 'Bearer ' + sessionStorage.access_token},
              dataType: 'text',
              success: function(data){
                          $('#athletes').empty();
                          var json = $.parseJSON(data);
                          json = json.reverse();
                          $('#athletes').append(
                                  'Send Athlete Username & Password: <table id="workouts-table" class="table table-striped table-hover">' +
                                        '<thead>' +
                                              '<tr>' +
                                                    '<th class="hidden-xs hidden-sm hidden-md hidden-lg">id</th>'+
                                                    '<th>First Name</th>'+
                                                    '<th>Last Name</th>' + 
                                                    '<th>Username</th>' +
                                                    '<th>Tag ID</th>' + 
                                                    '<th>Email</th>' + 
                                              '</tr>'+
                                        '</thead>'+
                                        '<tbody>'+
                                        '</tbody>' +
                                  '</table>');
                          $('#athletes').addClass('col-md-6 col-md-offset-0 colr-sm-8 col-sm-offset-0');
                          for (var ii=0;ii < json.length;ii++){
               //alert(ii);
                                id = json[ii].id;
                                fname = json[ii].first_name;
                                lname = json[ii].last_name;
                                uname = json[ii].username;
                                tag = json[ii].tag;
                                email = json[ii].email;
                                $('#athletes tbody').append(
                                      '<tr id="formtr" data-href="/individual/'+id+'/">' +
                                          '<td id="id" class="hidden-xs hidden-sm hidden-md hidden-lg"><input id="id" type="text" class="form-control" value="' + id + '" readonly></td>' +
                                          '<td><input id="first_name" type="text" class="form-control" value="'+fname+'" readonly></td>'+
                                          '<td><input id="last_name" type="text" class="form-control" value="'+lname+'" readonly></td>'+
                                          '<td><input id="username" type="text" class="form-control" value="'+uname+'" required readonly></td>' +
                                          '<td><input id="id_str" type="text" class="form-control" value="'+tag+'" required readonly></td>' +
                                          '<td><input id="email" type="text" class="form-control" value="'+email+'" required></td>' +
                                          '<td><input type="button" id="submit" class="form-control btn btn-primary" value="Send Email"></td>'+
                                      '</tr>');
                          }
                    }
          });
          
      });
      $('#edit-information').on('submit', function(e){
          e.preventDefault();
          $('#edit-information').hide();
          var organization = escapeString($('input#organization').val());
          var username = escapeString($('input#username').val());
          var email = escapeString($('input#email').val());
          $.ajax({
                  type: "PATCH",
                  url: "/api/users/me/",
                  headers: {Authorization: 'Bearer ' + sessionStorage.access_token},
                  data: {
                    //org: organization,
                    username: username,
                    email: email,
                  },
                  success: function(data){
                    alert('Profile Information Edited');
                  },
                  error: function(xhr, errmsg, err){
                  }
          });
      });
      $('#athletes').on('click','input#submit', function(e){
          e.preventDefault();
          var value = $(this).closest('tr');
            var id=value.find('input[id=id]').val();   
            var fname=value.find('input[id=first_name]').val();
            var lname=value.find('input[id=last_name]').val();
            var uname=value.find('input[id=username]').val();
            var id_str=value.find('input[id=id_str]').val();
            var email=value.find('input[id=email]').val();
          //alert(id);
         // alert(fname);
          
          $.ajax({
           type: "POST",
           dataType:'json',
           url: "/api/give_athlete_password/",
           headers: {Authorization: "Bearer " + sessionStorage.access_token},
           data: {
               id: id,
               first_name: fname,
               last_name: lname,
               username: uname,
               id_str: id_str,
               email: email,
               
           }, 
                      success: function(data) {
                      alert("Success")
                    },
                     error: function(xhr, errmsg, err){
                      alert ("Error Sending Email.");
                    }
                });
         
      });
      $('#edit-password').on('submit', function(e){
          e.preventDefault();
          $('#edit-password').hide();
          var o_password = escapeString($('input#o_password').val());
          var password = escapeString($('input#n_password').val());
          var c_password = escapeString($('input#c_password').val());
          if(password === c_password){
          $.ajax({
                  type: "POST",
                  url: "/api/users/me/change_password/",
                  headers: {Authorization: 'Bearer ' + sessionStorage.access_token},
                  data: {
                    old_password: o_password,
                    new_password: password,
                  },
                  success: function(data){
                    if (data != 403){
                      alert('Password Changed');
                    }
                    else{
                      alert('Unauthorized');
                    }
                  },
                  error: function(xhr, errmsg, err){
                    alert('Could Not Change Password');
                  }
          });
        }
        else{
          alert('passwords mismatch');
        }
      });  

      $('a#e_profile').click();    
});
</script>
<div class="container fluid-content">
  <div class="content" id ="content">
    <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3 pull-left" >
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title" style="text-align:left">Settings</h3>
        </div>
          <div class="panel-body">
            <a href="" id="e_profile"><img src="{% static "img/general.png" %}" width="20px"> General</a><br>
            <a href="" id="e_password"><img src="{% static "img/security.png" %}" width="20px"> Security</a><br>
            <a href="" id="e_roster"><img src="{% static "img/peopleicon.png" %}" width="20px"> Team</a><br>
            <a href="" id="e_payment"><img src="{% static "img/payment.png" %}" width="20px"> Payments</a><br>
            <a href="/payments/subscribe/" id=""><span class="glyphicon glyphicon-retweet"></span> Subscription</a><br>
            <a href="/payments/history/" id=""><span class="glyphicon glyphicon-book"></span> History</a><br>
            
          </div>
      </div>
    </div>

    <div class = "col-lg-9 col-md-9 col-sm-9 col-xs-9">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title" id="display-title"></h3>
        </div>
          <div class="panel-body">
            <form id="edit-information" name="edit-information"  class="pull-left" style="display: none;" data-parsley-validate>
              <div class="form-group">
                <label for="organization">Organization</label><br>
                <input type="text" id="organization" name="organization" class="form-group form-control" required autofocus data-parsley-group="block1" readonly>
                <label for="username">Username</label><br>
                <input type="text" id="username" name="username" class="form-group form-control" required autofocus data-parsley-group="block1">
                <label for="email">Email</label><br>
                <input type="text" id="email" name="email" class="form-group form-control" required autofocus data-parsley-group="block1">
                <div class="btn-group" role="group">
                  <button type="submit" id="submit" class="btn btn-success form-control">Update Profile</button>
                </div>
              </div>
            </form>
            <form id="edit-password"  class="pull-left"name="edit-password" style="display: none;" data-parsley-validate>
              <div class="form-group">
                <label for="o_password">Old Password</label><br>
                <input type="password" id="o_password" name="o_password" class="form-group form-control" required autofocus data-parsley-group="block1">
                <label for="n_password">New Password</label><br>
                <input type="password" id="n_password" name="n_password" class="form-group form-control" required autofocus data-parsley-group="block1">
                <label for="c_password">Confirm New Password</label><br>
                <input type="password" id="c_password" name="c_password" class="form-group form-control" required autofocus data-parsley-group="block1">
                <div class="btn-group" role="group">
                  <button type="submit" id="submit" class="btn btn-success form-control">Update Password</button>
                </div>
              </div>
            </form>
            <div id='payment' class="pull-left" style='display: none; width:40%'></div> 
            <div id="athletes" class="table pull-left" style='display: none;'>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
