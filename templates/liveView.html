{% extends "base.html" %}
{% load staticfiles %}

{% block content %}
  <div id="bg2">  
     
	  <div class="content">

 <h2> Live Results</h2>
    <table id="results" style="width:100%"></table>
    
    <div id="notifications">
        <h6 class="notification notification-default" role="alert">There is currently no data for the most recent event.</h6>
    </div>
    
<div class="button-container">
  <input type="submit" name="" class="gen_btn" id="submit" value="Download" />
</div>


 <script>

        //When DOM loaded we attach click event to button
        $(document).ready(function() {
            
	    
	    
	    //alert(idjson);
		    
		    
		    
		    
	  var repeated_function = function(idjson){
	    //alert(idjson);
	    var last_url = "/api/sessions/"+ idjson;
	   // alert(last_url);
                //start ajax request
                $.ajax({
                    url: last_url,
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data) {
                        
                        //data downloaded so we call parseJSON function 
                        //and pass downloaded data
                        var json = $.parseJSON(data);
			json = $.parseJSON(json.results);
                        //now json variable contains data in json format
                        //let's display a few items
                       // $('#results').html('Date: ' + json.date);
			//$('#results').append('<p> Workout ID: '+ json.workoutID);
			if (json.runners == undefined) {
			    $("h6.notification.notification-default").show();
			}
			else {
			$('#results').empty();
			for (var i=0; i < json.runners.length; i++) {
			  //print names and enter name array
			  var name = json.runners[i].name;
			  //prints all splits with no nesting
			  //var interval = json.runners[i].interval
			  if (i==0) {
			    $('#results').append('<tr><td>Name</td></tr>');
			    $('#results').append('<tr class="odd"><td>'+name+'</td></tr>');
			  }
			  else if((i)%2 ==0) {
			    $('#results').append('<tr class="odd"><td>'+name+'</td></tr>');
			  }
			  else{
			    $('#results').append('<tr><td>'+name+'</td></tr>');
			  }
			  
			  
			  var finaltime = 0;
			  
			  for (var j=0; j < json.runners[i].interval.length; j++) {
			    //iterate over interval to get to nested time arrays
			    var interval = json.runners[i].interval[j];
			    //$('#results').append( "Interval Subset: ")
			    

			    for (var k=0; k < json.runners[i].interval[j].length; k++) {
			      //interate over subarrays and pull out each individually and print
			      var subinterval = json.runners[i].interval[j][k];
			      var min = Math.floor(subinterval/60);
			      var sec = (subinterval-(min*60));
			     // $('#results').append('<td>');
			      //This if statements adds the preceding 0 to any second less than 10
			      
			      if (sec<10) {
				$('#results tr:last').append('<td>'+ min + ':0'+ sec +'</td>');
			      }
			      else
			      {
			      $('#results tr:last').append('<td>'+ min + ':'+ sec +'</td>');
			      }
			      finaltime = finaltime + subinterval;
			      if (i==0) {
				//Puts the word 'split #' on table
				$('#results tr:first').append('<td>Split '+(k+1)+'</td>');
			      }
			    }
			    
			    
			  }
			  
			  
			  
			   var minfinal = Math.floor(finaltime/60);
			   var secfinal = (finaltime-(minfinal*60));
			   //$('#results').append('<td>');
			   if (secfinal<10) {
			    $('#results tr:last').append( minfinal + ':0'+ secfinal );
			   }
			   else{
			   $('#results tr:last').append( minfinal + ':'+ secfinal);
			   };
			   if (i==0) {
				//adds word final time to table header
				$('#results tr:first').append('<td>Final Time</td>');
			      }
			//$('#results').append('' );
			
			}
			
			}
			
                    }
                });}
		
		
		var lastWorkout = function(){
		$.ajax({
                    url: "/api/sessions/",
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data){
		      var json = $.parseJSON(data);
			//alert(json.length);
			var idjson = json[json.length - 1].id;
			//alert(idjson);
			repeated_function(idjson);
			return idjson;
		    }
		    
	    });
		}
		
		
	    lastWorkout();
	   setInterval(lastWorkout,5000);

	


//Download to Excel Script

    $('#submit').click(function(){
        $.ajax({
                    url: "/api/sessions/",
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data){
		      var json = $.parseJSON(data);
			//alert(json.length);
			var idjson = json[json.length - 1].id;
			//alert(idjson);
			urlfn(idjson);
			return idjson;
		    }
		    
	    });
    });
});
	

  
  var urlfn = function(idjson){
    var last_url = "/api/sessions/"+ idjson;
    //alert(last_url);
     $.ajax({
                    url: last_url,
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data) {
        
        JSONToCSVConvertor(data, "TRAC_Report", true);}});
  }
  
  
function JSONToCSVConvertor(JSONData, ReportTitle, ShowLabel) {
    //Data coming in must be json
    //parse through it
    var json = $.parseJSON(JSONData);
  //now json variable contains data in json format
  //let's display a few items
 // $('#results').html('Date: ' + json.date);
  //$('#results').append('<p> Workout ID: '+ json.workoutID);
  
  
  
    var CSV = '';    
    //Set Report title in first row or line
    
    CSV += ReportTitle + '\r\n\n';
    CSV += 'Date,'+ json.start_time+'\r\n';
    CSV += 'Workout ID,'+ json.id+'\r\n\n';
   //alert(CSV);
   CSV += 'Name \r\n'
   //Uncomment below when using nested json in production
   json = $.parseJSON(json.results);
   
	      //iterate into name array
	       for (var i=0; i < json.runners.length; i++) {
		  //print names and enter name array
		  var name = json.runners[i].name; 
		    CSV +=name+',';
		  
		//alert(CSV);
   
   
			for (var j=0; j < json.runners[i].interval.length; j++) {
			    //iterate over interval to get to nested time arrays
			    var interval = json.runners[i].interval[j];

			    for (var k=0; k < json.runners[i].interval[j].length; k++) {
			      //interate over subarrays and pull out each individually and print
			      //do a little math to move from seconds to minutes and seconds
			      var subinterval = json.runners[i].interval[j][k];
			      var min = Math.floor(subinterval/60);
			      var sec = (subinterval-(min*60));
			      
			      //This if statements adds the preceding 0 to any second less than 10
			      if (sec<10) {
				CSV += min + ':0'+sec+',';
			      }
			      else
			      {
			      CSV += min + ':'+sec+',';
			      }
			      
			    }
			  }
			  //moves to new row on excel spreadsheet
			  CSV += '\r\n'
	       }
   
   //if varaible is empty, alert invalid and return
    if (CSV == '') {        
        alert("Invalid data");
        return;
    }
    
    //Generate a file name
    var fileName = "MyReport_";
    //this will remove the blank-spaces from the title and replace it with an underscore
    fileName += ReportTitle.replace(/ /g,"_");   
    
    //Initialize file format you want csv or xls
    var uri = 'data:text/csv;charset=utf-8,' + escape(CSV);
    
    // Now the little tricky part.
    // you can use either>> window.open(uri);
    // but this will not work in some browsers
    // or you will not get the correct file extension    
    
    //this trick will generate a temp <a /> tag
    var link = document.createElement("a");    
    link.href = uri;
    
    //set the visibility hidden so it will not effect on your web-layout
    link.style = "visibility:hidden";
    link.download = fileName + ".csv";
    
    //this part will append the anchor tag and remove it after automatic click
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
    
    
    
    
    
        </div>
     
      </div>
{% endblock %} 
    
    
    
</html>



