{% extends "base_new.html" %}
{% load static %}

{% block stylesheets %}
<link rel="stylesheet" href="{% static "css/new/settings.css" %}">
{% endblock %}

{% block js_scripts %}

<script type="text/javascript" src="{% static "js/timeConversion.js" %}" />
<!--<script type="text/javascript" src="{% static "js/new/race_angular.js" %}"></script>-->
{% endblock %}

{% block content %}
<style>
    #coachform{
      width:300px;
      margin: 0 auto;
    }
    label{
      display:block;
    }
    input,textarea{
      width:75%;
    }
    @media (min-width: 768px) {
      .modal-xl {
        width: 90%;
       max-width:1200px;
      }
    }

    #rosterModal .modal-body {
    max-height: 450px;
    overflow-y: auto;
}
  .glyphicon{
    cursor: pointer;
  }
  .glyphicon-pencil{
    color: #ccc;
  }
  .glyphicon-remove, .glyphicon-eject, .glyphicon-save{
    color: #ccc;
  }
    .glyphicon-pencil:hover { color: #337ab7; }
    .glyphicon-remove:hover { color: #d9534f; }
    .glyphicon-eject:hover { color: #ffad33; }
    .glyphicon-save:hover { color: #337ab7;}
    .form-group{
      margin-bottom: 0px !important;
    }
  nav ul{
    margin-bottom:0px !important;
  }
  </style>

  <script>
  var app = angular.module('raceRegistration', []);


   app.controller('registeredCtrl', function($scope, $http) {
    $scope.regNull = false;
    $scope.editing_header = true;

    $http({method: 'GET', url: '/api/athletes/', headers: {Authorization: 'Bearer ' + sessionStorage.access_token} })
    .success(function (response) { 
      $scope.athletes = response;
      if (response.length == 0){
        $scope.regNull = true;
      }

    });


    $http({method: 'GET', url: '/api/sessions/', headers: {Authorization: 'Bearer ' + sessionStorage.access_token}, params:{offset:0, limit:15} })
    .success(function (response) { 
      
      $scope.json = response.results;
      $scope.idArray = response.results.id;
      $scope.temporaryEnd = 15;

    });

    //onClick event of session, dynamically route athletes. 
    $scope.select = function(workout) {
        var selected = workout.id;
        var url = '/api/athletes/?session='+ selected;
        $http({method: 'GET', url: url, headers: {Authorization: 'Bearer ' + sessionStorage.access_token} })
          .success(function (response) { 
            $scope.athletes = response;
            if (response.length == 0){
               $scope.regNull = true;
            }

          });

      };
    $scope.seeMore = function(){

      $http({method: 'GET', url: '/api/sessions/', headers: {Authorization: 'Bearer ' + sessionStorage.access_token}, params:{offset:$scope.temporaryEnd, limit:15} })
        .success(function (response) { 
          //merge arrays
        $scope.temporaryEnd += 15;
        $scope.json.push.apply($scope.json, response.results);
      });

    }

    $scope.delete = function(array,index,runner){
      $scope.athletes.splice(index, 1);
      console.log($scope.athletes);
      //TODO: Do an ajax call, to actually delete
       var url = '/api/athletes/'+runner.id +'/';
       $http({method: 'DELETE', url: url, headers: {Authorization: 'Bearer ' + sessionStorage.access_token}})
         .success(function (response) { 
           console.log('Successfully Deleted');
       });
    }

    $scope.save = function(runner){
      var url = '/api/athletes/'+runner.id +'/';
      $http({method: 'PUT', url: url, headers: {Authorization: 'Bearer ' + sessionStorage.access_token}, data:{
        user:{
        first_name: runner.user.first_name,
        last_name: runner.user.last_name,
        username: runner.user.username,
        },
        tag: runner.tag,
        team: runner.team,

       } 
      })
        .success(function (response) { 
         alert('successfully changed');
      });
      //TODO: Do an ajax call, to actually save
    }

    // editing contact info
    $scope.editing = false;
    $scope.edit = function(x) {

      if ($(window).width() < 768) {
        $scope.val = x;
        // do something for small screens
        $('#editAthlete').modal('show');

      }
      else if ($(window).width() >= 768 &&  $(window).width() <= 992) {
          // do something for medium screens
          $('#editAthlete').modal('show');
          $scope.val = x;
      }
      else  {
        var dynamicString = 'editing_' + x.id;
        console.log(dynamicString);
        $scope[dynamicString] = true;
          // do something for huge screens
      }
     // var selectedID = angular.element(obj.target).parent().parent().parent().attr('id');
     console.log($scope.val);
      
    };


    $scope.cancel = function(obj) {
      var selectedID = angular.element(obj.target).parent().parent().parent().attr('id');
      var dynamicString = 'editing_' + selectedID;
      $scope[dynamicString] = false;
    };


    $scope.showSelected = function(){
      var atlList = [];
      $('#rosterModal tr.ath').each(function(){
        var atlObj = {};
        if ($(this).find('td #check').is(":checked")){
          atlObj.id = $(this).children('#id').text();
          atlList.push(atlObj);
        }
      });
      //TODO: Ajax Call to api/sessions with data.
      $('#rosterModal').modal('hide');
    }
    $scope.header = function(){
      $scope.editing_header = false;
    }
    $scope.cancelHeader = function(){
      $scope.editing_header = true;
    }
    $scope.saveHeader = function(runner){
      $http({method: 'POST', url: '/api/athletes/', headers: {Authorization: 'Bearer ' + sessionStorage.access_token}, data:{
        user:{
        first_name: runner.user.first_name,
        last_name: runner.user.last_name,
        username: runner.user.username,
        },
        tag: runner.tag,
        team: runner.team,

       } 
      })
        .success(function (response) { 
         alert('successfully changed');
      });

    }


  });
   


  </script>


{% verbatim angular %}

<div ng-app="raceRegistration" id="containerDiv" ng-controller="registeredCtrl">
<nav class="pushy pushy-left">
    <ul class="menulist" ng-repeat='x in json' > 
      <li id="$index"><a href="#" ng-click="select(x)">{{x.name}}</a></li>
    </ul>
    <ul class="menulist" ng-repeat-end ng-if="json.length == temporaryEnd">
      <li><a href="#" ng-click="seeMore();">See More</a></li>
    </ul>
</nav>
  <div class="site-overlay"></div>
    <div id="content">  
        <div class="container-fluid content">
          <div  class="container"> 
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <div class="row" style="margin-bottom:2%">
        <div class="col-md-6 col-sm-6 col-xs-6" style="">
          <div id="menu-btn" class="menu-btn" style="display: inline-block;">
            <span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span> Heat Menu
          </div>
        </div>
        <div class="col-md-6 col-sm-6 col-xs-6" style="">
          <div id="" class="" data-toggle="modal" data-target="#rosterModal" style="float:right">
            <span class="glyphicon glyphicon-list" aria-hidden="true"></span> Roster
          </div>
        </div>
      </div>

            <div class="row">
              <div class="col-lg-offset-10 col-md-offset-10 col-sm-offset-10 col-xs-offset-10">
              <button type="button" class="btn btn-default hidden-xs" id="plus" data-toggle="modal" data-target="#csvModal">
                  <span class="glyphicon glyphicon-plus" aria-hidden="true"> </span> CSV Upload
              </button>
            </div>
            <h1 id="score-title">Registration</h1>
            </div>
            <div class="spinner-container" style="position:relative; top:100px;">
                <div id="spinner"></div>
            </div>
            <div class="row">
              <div id="athletes" class="table">
                <table id="results-table" class="table table-striped table-hover">
                  <thead ng-hide="regNull">
                    <tr>
                      <th class="hidden-xs hidden-sm hidden-md hidden-lg">id</th>
                      <th>First Name</th>
                      <th>Last Name</th>
                      <th style="display:none">Username</th>
                      <th>Tag ID</th>
                      <th>Team</th>
                      <th class="hidden-xs hidden-sm">Year</th>
                      <th class="hidden-xs hidden-sm">Gender</th>
                    </tr>
                  </thead>
                <tbody>
                  <tr ng-repeat="x in athletes" id="{{x.id}}">
                    <td class="hidden-xs hidden-sm hidden-md hidden-lg" >{{x.id}}</td>
                    <input name="{{ name }}" type="text" ng-model="x.id" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control">
                    <td>
                      <div class="form-group">
                        <div ng-bind="x.user.first_name" ng-hide="editing_{{x.id}}"></div> 
                        <input name="{{ name }}" type="text" ng-model="x.user.first_name" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control">
                      </div>
                    </td>
                    <td>
                        <div class="form-group">
                          <div ng-bind="x.user.last_name" ng-hide="editing_{{x.id}}"></div> 
                          <input name="{{ name }}" type="text" ng-model="x.user.last_name" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control">
                        </div>
                    </td>
                    <td style="display:none">{{x.user.username}}</td>
                    <td>
                      <div class="form-group">
                        <div ng-bind="x.tag" ng-hide="editing_{{x.id}}"></div> 
                        <input name="{{ name }}" type="text" ng-model="x.tag" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control">
                      </div>
                    </td>
                    <td>
                      <div class="form-group">
                        <div ng-bind="'Northwestern'" ng-hide="editing_{{x.id}}"></div> 
                        <input name="{{ name }}" type="text" ng-model="x.team" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control">
                      </div>
                    </td>
                    <td class="hidden-xs hidden-sm">
                      <div class="form-group">
                        <div ng-bind="x.year" ng-hide="editing_{{x.id}}"></div> 
                        <input name="{{ name }}" type="text" ng-model="x.year" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control" style="width:70px;">
                      </div>
                    </td>
                    <td class="hidden-xs hidden-sm">
                      <div class="form-group">
                        <div ng-bind="x.gender" ng-hide="editing_{{x.id}}"></div> 
                        <input name="{{ name }}" type="text" ng-model="x.gender" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control" style="width:40px;">
                      </div></td>
                    <td>
                        <div class="buttons" editing="editing" ng-hide="editing_{{x.id}}">
                          <span class="glyphicon glyphicon-pencil" aria-hidden="true" data-ng-click="edit(x);" style="margin-right:5%"></span>
                          <span class="glyphicon glyphicon-remove" aria-hidden="true" ng-click="delete(athletes,$index,x)"></span>
                        </div>
                        <div class="buttons hidden-xs hidden-sm" ng-show="editing_{{x.id}}">
                          <button name="" class="btn btn-primary" ng-click="save(x)">Save</button>
                          <button name="" class="btn" ng-click="cancel($event)">Cancel</button>
                        </div>
                        <div class="buttons hidden-lg hidden-xl" ng-show="editing_{{x.id}}" >
                          <span class="glyphicon glyphicon-save" aria-hidden="true" ng-click="save(x);" style="margin-right:5%"></span>
                          <span class="glyphicon glyphicon-eject" aria-hidden="true" ng-click="cancel($event);"></span>
                        </div>
                    </td>
                  </tr>
                </tbody>
              </table>

              </div>
              <div style="text-align: center;">
              <p id="inputheader" class="notification-error notification-default" role="alert" ng-show="regNull">
              <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> Please Select Workout to Manage from Heat Menu.
              </p>
              <p id="inputnoneheader" class="notification-error notification-none" role="alert" style="display:none">
              <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> Add Athletes from Roster to Workout.
              </p>
            </div>
            </div>
          </div>

      </div>
      <div id="create" class="container">
<!--Roster Modal -->
<div class="container">
  <div class="modal fade" id="rosterModal" role="dialog">
    <div class="modal-dialog modal-xl">
      <div class ="modal-content">
        <div class="modal-header">
          Roster Upload <button id="cl" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span></button>
          </div>
          <div class="modal-body" ng-controller="registeredCtrl">
          <table id="results-table" class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th class="hidden-xs hidden-sm hidden-md hidden-lg">id</th>
                      <th>
                        <div class="form-group">
                          <div ng-bind="'Register'"></div> 
                        </div>
                      </th>
                      <th>
                        <div class="form-group">
                          <div ng-bind="'First Name'" ng-show="editing_header"></div> 
                          <input id="check" placeholder="First Name" ng-model="selected[x.id]" ng-hide="editing_header" class="form-control">
                        </div>
                      </th>
                      <th>
                        <div class="form-group">
                          <div ng-bind="'Last Name'" ng-show="editing_header"></div> 
                          <input id="check" placeholder="Last Name" ng-model="selected[x.id]" ng-hide="editing_header" class="form-control">
                        </div>
                      </th>
                      <th style="display:none">Username</th>
                      <th>
                        <div class="form-group">
                          <div ng-bind="'Tag ID'" ng-show="editing_header"></div> 
                          <input id="check" placeholder="Tag ID" ng-model="selected[x.id]" ng-hide="editing_header" class="form-control">
                        </div>
                      </th>
                      <th>
                        <div class="form-group">
                          <div ng-bind="'Year'" ng-show="editing_header"></div> 
                          <input id="check" placeholder="Year" ng-model="selected[x.id]" ng-hide="editing_header" class="form-control" style="width:70px;">
                        </div>
                      </th>
                      <th>
                        <div class="form-group">
                          <div ng-bind="'Gender'" ng-show="editing_header"></div> 
                          <input id="check" placeholder="M/F" ng-model="selected[x.id]" ng-hide="editing_header" class="form-control" style="width:60px;">
                        </div>
                      </th>
                      <th style="width:50px;">
                        <button type="button" class="btn btn-default hidden-xs" ng-click="header();" ng-show="editing_header" style="margin-left:50%">
                          <span class="glyphicon glyphicon-plus" aria-hidden="true"> </span> Runner
                       </button>
                       <div class="buttons" ng-hide="editing_header">
                          <span class="glyphicon glyphicon-save" aria-hidden="true" ng-click="saveHeader(x);" style="margin-right:5%"></span>
                          <span class="glyphicon glyphicon-eject" aria-hidden="true" ng-click="cancelHeader();"></span>
                        </div>
                     </th>
                    </tr>
                  </thead>
                <tbody>
                  <tr ng-repeat="x in athletes" id="{{x.id}}" class="ath">
                    <td><input type="checkbox" id="check" ng-model="selected[x.id]" ng-hide="editing_{{x.id}}"></td>
                    <td class="hidden-xs hidden-sm hidden-md hidden-lg" id="id">{{x.id}}</td>
                    <td>
                      <div class="form-group">
                        <div ng-bind="x.user.first_name" ng-hide="editing_{{x.id}}"></div> 
                        <input name="{{ name }}" type="text" ng-model="x.user.first_name" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control">
                      </div>
                    </td>
                    <td>
                        <div class="form-group">
                          <div ng-bind="x.user.last_name" ng-hide="editing_{{x.id}}"></div> 
                          <input name="{{ name }}" type="text" ng-model="x.user.last_name" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control">
                        </div>
                    </td>
                    <td style="display:none">{{x.user.username}}</td>
                    <td>
                      <div class="form-group">
                        <div ng-bind="x.tag" ng-hide="editing_{{x.id}}"></div> 
                        <input name="{{ name }}" type="text" ng-model="x.tag" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control">
                      </div>
                    </td>
                    <td class="hidden-xs hidden-sm">
                      <div class="form-group">
                        <div ng-bind="x.year" ng-hide="editing_{{x.id}}"></div> 
                        <input name="{{ name }}" type="text" ng-model="x.year" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control" style="width:70px;">
                      </div>
                    </td>
                    <td class="hidden-xs hidden-sm">
                      <div class="form-group">
                        <div ng-bind="x.gender" ng-hide="editing_{{x.id}}"></div> 
                        <input name="{{ name }}" type="text" ng-model="x.gender" ng-show="editing_{{x.id}}" placeholder="{{ placeholder }}" class="form-control" style="width:40px;">
                      </div></td>
                    <td>
                    <td>
                        <div class="buttons" editing="editing" ng-hide="editing_{{x.id}}">
                          <span class="glyphicon glyphicon-pencil" aria-hidden="true" ng-click="edit(x);" style="margin-right:5%"></span>
                          <span class="glyphicon glyphicon-remove" aria-hidden="true" ng-click="delete(athletes,$index);"></span>
                        </div>
                        <div class="buttons" ng-show="editing_{{x.id}}">
                          <span class="glyphicon glyphicon-save" aria-hidden="true" ng-click="save(x);" style="margin-right:5%"></span>
                          <span class="glyphicon glyphicon-eject" aria-hidden="true" ng-click="cancel($event);"></span>
                        </div>
                    </td>
                  </tr>
                </tbody>
              </table>
        </div>
        <div class="modal-footer">
          <div class="button-container" style="display:table; margin:0 auto;">
            <button name="" class="btn btn-primary" id="registerRunners" ng-click="showSelected();">Register Runners</button>
           </div>
       </div> 
      </div>
    </div>
  </div>
</div>


<!--End Modal -->
  <div class="modal fade" id="notificationModal" role="dialog">
    <div class="modal-dialog">
      <div class ="modal-content">
        <div class="modal-body">
          <div id="notifications">
              <div class="notification notification-critical" role="alert">Some information you entered isn't right.</div>
              <div class="notification start-success" role="alert">You have started a workout!</div>
              <div class="notification open-success" role="alert">You have opened a workout!</div>
               <div class="notification close-success" role="alert">You have closed a workout!</div>
            <div class="notification notification-success" role="alert">You have successfully added tag(s) to a workout!</div>
            <div class="notification delete-success" role="alert">You have successfully delinked a tag from the workout!</div>
            <div class="notification update-success" role="alert">You have successfully updated a tag!</div>
            <div class="notification notification-warning" role="alert" style="display:table; margin:0 auto;">Are you sure? <div id="screen-selector"><button href="#" type="button" id="warning-yes" class="btn btn-danger" >Yes</button><button href="#" type="button" id="warning-yes2" class="btn btn-danger" >Yes</button><button id="warning-no" href="#" type="button" style="margin-left:2px;" data-dismiss="modal" data-toggle="modal" data-target="#myModal" class="btn btn-primary">Cancel</button></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
      <div class="container">
  <div class="modal fade" id="csvModal" role="dialog">
    <div class="modal-dialog">
      <div class ="modal-content">
        <div class="modal-header">
          CSV Upload <button id="cl" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span></button>
        </div>
        <div class="modal-body">
          <form name="csvform" id="csvform" data-parsley-validate>
          <div class="form-group">
            <label for="">Workout Name:</label> 
            <input data-progression="" type="text" data-helper="" id="name" value="" placeholder="" class="form-control" required/>
          </div>
          <div class="form-group">
            <label for="">Workout Date:</label> 
            <input data-progression="" type="text" data-helper="" id="date" value="" placeholder="" class="form-control" required/>
          </div>
          <div class="form-group">
            <label for="">Confirm Username:</label> 
            <input data-progression="" type="text" data-helper="" id="coach_username" value="" placeholder="" class="form-control" required/>
          </div>
          <div class="form-group">
            <label for="">Readers:</label> 
            <input data-progression="" type="text" data-helper="" id="readers" value="" placeholder="" class="form-control" required/>
          </div>
          <div class="spinner-container">
                <div id="spinner_modal"></div>
            </div>

            <div class="form-group">
              <label for="file">Select file:</label>
              <div class="input-group">
                <span class="input-group-btn">
                  <span class="btn btn-warning btn-file">
                    Browse&hellip; <input type="file" id="file" name="myfile" data-parsley-errors-container="#csv-parsley-errors">
                  </span>
                </span>
                <input type="text" class="form-control" readonly required data-parsley-errors-container="#csv-parsley-errors">
              </div>
              <div id="csv-parsley-errors"></div>
            </div>

             <div class="button-container" id="csv_buttons"style="display:table;margin:0 auto;">
                <!--<input type="file" id="file" name="myfile" class="btn btn-warning form-control" required>-->
                <input type="submit" class="gen_btn btn btn-primary form-control" id="upload" name ="upload" value="Upload">
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

      <div class="container">
        <div class="modal fade" id="editAthlete" role="dialog">
          <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                Edit Registered Athlete <button id="cl" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span></button>
              </div>
              <div class="modal-body">
                <form name="tracform" id="coachform" method="POST" data-parsley-validate>
                  <div class="button-container-two">
                  </div>
                    <p id="idnumber">
                     
                      <input type="hidden" id="idnumber" value="" placeholder="" ng-model="val.id" required data-parsley-group="block1" readonly/>
                  </p>
                 <div class="form-group">
                     <label for="">First Name:</label> 
                     <input data-progression="" type="text" id="fname" value="" ng-model="val.user.first_name" required data-parsley-group="block1" class="form-control"/>
                 </div>
                 <div class="form-group">
                     <label for="">Last Name:</label> 
                     <input data-progression="" type="text" id="lname" value="" placeholder="" ng-model="val.user.last_name" required data-parsley-group="block1" class="form-control"/>
                 </div>
                 <input type="hidden" id="uname" value="" placeholder="" required data-parsley-group="block1" ng-model="val.user.username" readonly/>
                  <div class="form-group">
                     <label for="">TagID:</label> 
                     <input data-progression="" type="text" id="tag" value="" placeholder="" required data-parsley-group="block1" ng-model="val.tag" class="form-control"/>
                 </div>
                 <div class="form-group">
                     <label for="">Age:</label> 
                     <input data-progression="" type="text" id="age" value="" placeholder="" required data-parsley-group="block1" ng-model="val.year" class="form-control"/>
                 </div>
                 <div class="form-group">
                     <label for="">Gender:</label> 
                     <input data-progression="" type="text" id="gender" value="" placeholder="" required data-parsley-group="block1" ng-model="val.gender" class="form-control"/>
                 </div>
                    <br>
                    </form>   
                     </div> 
                        <div class="modal-footer">
                          <div class="button-container" style="display:table; margin:0 auto;">
                            <button name="" class="btn btn-primary" id="update"  data-dismiss="modal" data-toggle="modal" data-target="#notificationModal">Update</button>
                           </div>
                     </div> 
                 </div>
              </div>
          </div> 
      </div>
    </div>
</div>
   {% endverbatim angular %}
   {% endblock %} 
    
    
    
</html>
