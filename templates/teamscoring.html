{% extends "base.html" %}
{% load staticfiles %}

{% block content %}
  <div class="modal-animate hide">
    <div class="rotate"></div>

</div>
  
  <div id="bg2">  
     
	  <div class="content">
		  
		  <input type="file" id="file" name="myfile" value="Choose File">
		  <input type="submit" class="gen_btn" id="upload" name ="upload" value="Upload">
		  

 <h2> Live Results</h2>
 <div class="inner">
    <table id="results" style="width:100%"></table>
    </div>
    <button onclick="javascript:demoFromHTML();">PDF</button>
    <div id="notifications">
        <h6 class="notification notification-default" role="alert">There is currently no data for the most recent event.</h6>
        <h6 class="notification notification-default2" role="alert">No recent events to show.</h6>

    </div>
    
<div class="button-container">
  <input type="submit" name="" class="gen_btn" id="submit" value="Download" />
</div>

<script>


function demoFromHTML() {
    var pdf = new jsPDF('p', 'pt', 'letter')

// source can be HTML-formatted string, or a reference
// to an actual DOM element from which the text will be scraped.
, source = $('.inner')[0]

// we support special element handlers. Register them with jQuery-style
// ID selector for either ID or node name. ("#iAmID", "div", "span" etc.)
// There is no support for any other type of selectors
// (class, of compound) at this time.
, specialElementHandlers = {
    // element with id of "bypass" - jQuery style selector
    '#bypassme': function(element, renderer){
        // true = "handled elsewhere, bypass text extraction"
        return true
    }
}

margins = {
    top: 80,
    bottom: 60,
    left: 40,
    width: 522
  };
  // all coords and widths are in jsPDF instance's declared units
  // 'inches' in this case
pdf.fromHTML(
    source // HTML string or DOM elem ref.
    , margins.left // x coord
    , margins.top // y coord
    , {
        'width': margins.width // max width of content on PDF
        , 'elementHandlers': specialElementHandlers
    },
    function (dispose) {
      // dispose: object with X, Y of the last line add to the PDF
      //          this allow the insertion of new lines after html
        pdf.save('Test.pdf');
      },
    margins
  )
    
    
}


</script>
<script>
	    var stepped = 0, rowCount = 0, errorCount = 0, firstError;
		var inputType = "string";
	    $('#upload').click(function(){
			
			var config = buildConfig();
			
$('#file').parse({
			config:config,
			before: function(file, inputElem)
				{
					start = now();
					console.log("Parsing file...", file);
				},
				error: function(err, file)
				{
					console.log("ERROR:", err, file);
					firstError = firstError || err;
					errorCount++;
				},
			
			complete: function(){
				end = now();
				printStats("Done with all files");
				
				
			}
		});
	});
	
	function now()
{
	return typeof window.performance !== 'undefined'
			? window.performance.now()
			: 0;
}

function buildConfig()
{
	return {
		delimiter: '',
		header: true,
		dynamicTyping: $('#dynamicTyping').prop('checked'), //turn numbers into numbers or strings? yes no to boolean?
		skipEmptyLines:true,
		preview: parseInt($('#preview').val() || 0),
		step: $('#stream').prop('checked') ? stepFn : undefined,
		encoding: '',
		worker: true, //run on separate thread--slower but wont lock webpage
		comments: $('#comments').val(),
		complete: completeFn,
		error: errorFn,
		download: inputType == "remote"
	};
}

function stepFn(results, parser)
{
	stepped++;
	if (results)
	{
		if (results.data)
			rowCount += results.data.length;
		if (results.errors)
		{
			errorCount += results.errors.length;
			firstError = firstError || results.errors[0];
		}
	}
}

function completeFn(results)
{
	end = now();

	if (results && results.errors)
	{
		if (results.errors)
		{
			errorCount = results.errors.length;
			firstError = results.errors[0];
		}
		if (results.data && results.data.length > 0)
			rowCount = results.data.length;
			$('#file').val('');
	}

	printStats("Parse complete");
	console.log("    Results:", results);

	// icky hack
	//setTimeout(enableButton, 100);
}

function errorFn(err, file)
{
	end = now();
	console.log("ERROR:", err, file);
	//enableButton();
}
function printStats(msg)
{
	if (msg)
		console.log(msg);
	console.log("       Time:", (end-start || "(Unknown; your browser does not support the Performance API)"), "ms");
	console.log("  Row count:", rowCount);
	if (stepped)
		console.log("    Stepped:", stepped);
	console.log("     Errors:", errorCount);
	if (errorCount)
		console.log("First error:", firstError);
}
</script>
 <script>

        //When DOM loaded we attach click event to button
        $(document).ready(function() {
            //show spinner
	    $(".modal-animate").show();
	    
	    
	    //alert(idjson);
		    
		    
		    
		    
	  var repeated_function = function(idjson){
	    //alert(idjson);
	    var last_url = "/api/score/"+ idjson;
	   // alert(last_url);
                //start ajax request
                $.ajax({
                    url: last_url,
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data) {
                        
                        //data downloaded so we call parseJSON function 
                        //and pass downloaded data
                        var json = $.parseJSON(data);
                        
			json = $.parseJSON(json.final_results);
			
			var arr = json.toString().split(",");
			var count = arr.length;
			
                        //now json variable contains data in json format
                        //let's display a few items
                       // $('#results').html('Date: ' + json.date);
			//$('#results').append('<p> Workout ID: '+ json.workoutID);
			
			//if empty show notification, hide spinner, and show button
			
			if (json.runners == "") {
			    $(".modal-animate").hide();
			    $("h6.notification.notification-default").show();
			      $("input#submit.gen_btn").show();
			}
			else {
			    //hide spinner, show button, show results
			    $("div.inner").show();
			$(".modal-animate").hide();
			$("h6.notification.notification-default").hide();
			  $("input#submit.gen_btn").show();
			$('#results').empty();
			var counter = 0;
			var counter1 = 1;
			    $('#results').append('<tr><td>Place</td><td>Time</td><td>Name</td><td>Affiliation</td></tr>');
			for (var i=0; i < count; i++) {
			  //print names and enter name array
			  var name = arr[i];
			  
			 // alert(i);
			  //prints all splits with no nesting
			  //var interval = json.runners[i].interval
			  
			  if ((i)%3 ==0 & counter%2==0) {
				var tr = $('<tr class="odd">');
				 tr.append('<td>'+counter1+'</td>');
			    $('#results').append(tr);
			    tr.append('<td>'+name+'</td>');
			    counter1 = counter1 + 1;
			  }
			  else if ((i)%3 ==0 & counter%2==1) {
				var tr = $('<tr>');
				 tr.append('<td>'+counter1+'</td>');
			    $('#results').append(tr);
			    tr.append('<td>'+name+'</td>');
			    counter1 = counter1 + 1;
			  }
			  else if((i)%3 ==1) {
			    tr.append('<td>'+name+'</td>');
			  }
			  else if((i)%3 ==2){
			    tr.append('<td>'+name+'</td>');
			  }
			  
			  
			  counter = counter + 1;
			  

			  
			  

			}
			
			}
			
                    }
                });}
		
		
		var lastWorkout = function(){
		$.ajax({
                    url: "/api/score/",
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data){
		      var json = $.parseJSON(data);
			//alert(json.length);
			if (json.length==0){ 
				$("h6.notification.notification-default2").show();
				$(".modal-animate").hide();
				}
			else{
				 $("h6.notification.notification-default2").hide();
			var idjson = json[json.length - 1].id;
			//alert(idjson);
			repeated_function(idjson);
			return idjson;
		}
		    }
		    
	    });
		}
		

	    lastWorkout();


	


//Download to Excel Script

    $('#submit').click(function(){
        $.ajax({
                    url: "/api/sessions/",
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data){
		      var json = $.parseJSON(data);
			//alert(json.length);
			var idjson = json[json.length - 1].id;
			//alert(idjson);
			urlfn(idjson);
			return idjson;
		    }
		    
	    });
    });
});
	

  
  var urlfn = function(idjson){
    var last_url = "/api/score/"+ idjson;
    //alert(last_url);
     $.ajax({
                    url: last_url,
		    headers: {Authorization: "Bearer " + sessionStorage.access_token},
                    //force to handle it as text
                    dataType: "text",
                    success: function(data) {
        
        JSONToCSVConvertor(data, "TRAC_Report", true);}});
  }
  
  
function JSONToCSVConvertor(JSONData, ReportTitle, ShowLabel) {
    //Data coming in must be json
    //parse through it
    var json = $.parseJSON(JSONData);
  //now json variable contains data in json format
  //let's display a few items
 // $('#results').html('Date: ' + json.date);
  //$('#results').append('<p> Workout ID: '+ json.workoutID);
  
  
  
    var CSV = '';    
    //Set Report title in first row or line
    
    CSV += ReportTitle + '\r\n\n';

   //Uncomment below when using nested json in production
   json = $.parseJSON(json.final_results);
   var arr = json.toString().split(",");
			var count = arr.length;
	      //iterate into name array
	       var counter = 0;
			var counter1 = 1;
			CSV +='Place,Time,Name,Affiliation';
			CSV += '\r\n'
			for (var i=0; i < count; i++) {
			  //print names and enter name array
			  var name = arr[i];
			  
			 // alert(i);
			  //prints all splits with no nesting
			  //var interval = json.runners[i].interval
			  
			  if ((i)%3 ==0 & counter%2==0) {
				CSV +=counter1+',';
			    CSV +=name+',';
			    counter1 = counter1 + 1;
			  }
			  else if ((i)%3 ==0 & counter%2==1) {
				CSV +=counter1+',';
			    CSV +=name+',';
			    counter1 = counter1 + 1;
			  }
			  else if((i)%3 ==1) {
			    CSV +=name+',';
			  }
			  else if((i)%3 ==2){
			    CSV +=name+',';
			    CSV += '\r\n'
			  }
			  
			  
			  counter = counter + 1;
			  

			  
			  

			}
   
   //if varaible is empty, alert invalid and return
    if (CSV == '') {        
        alert("Invalid data");
        return;
    }
    
    //Generate a file name
    var fileName = "MyReport_";
    //this will remove the blank-spaces from the title and replace it with an underscore
    fileName += ReportTitle.replace(/ /g,"_");   
    
    //Initialize file format you want csv or xls
    var uri = 'data:text/csv;charset=utf-8,' + escape(CSV);
    
    // Now the little tricky part.
    // you can use either>> window.open(uri);
    // but this will not work in some browsers
    // or you will not get the correct file extension    
    
    //this trick will generate a temp <a /> tag
    var link = document.createElement("a");    
    link.href = uri;
    
    //set the visibility hidden so it will not effect on your web-layout
    link.style = "visibility:hidden";
    link.download = fileName + ".csv";
    
    //this part will append the anchor tag and remove it after automatic click
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
    
    
    
    
    
        </div>
     
      </div>
{% endblock %} 
    
    
    
</html>



